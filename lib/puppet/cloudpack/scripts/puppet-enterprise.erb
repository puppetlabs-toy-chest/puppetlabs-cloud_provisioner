#!/bin/bash
set -e
set -u
set -x

# The installer action determines a temporary directory internally
# This is not a user defined option.  You may assume this will be
# a unique string of characters.
cd '<%= options[:tmp_dir] %>'
install_dir=puppet-enterprise
mkdir "${install_dir}"

tar -xvzf puppet.tar.gz --strip-components 1 -C "${install_dir}"

<% if not options[:autogenerated_certname] %>
# If the puppet agent certname has been given on the command line using
# --puppetagent-certname=foobar then we should replace it in the answers file.
# (Note, the answers file has been uploaded by the face action)
# Let's play shuffle the files.
mv puppet.answers puppet.answers.orig
# Give me everything _except_ any agent certname specified in the answers file
grep -v '^q_puppetagent_certname' puppet.answers.orig > puppet.answers
# Append the user specified option from the command line arguments.
echo 'q_puppetagent_certname=<%= options[:puppetagent_certname] %>' >> puppet.answers
<% else %>
#If we have a certname specified in the answers file, use it
if ! grep '^q_puppetagent_certname' puppet.answers; then
  echo 'q_puppetagent_certname=<%= options[:puppetagent_certname] %>' >> puppet.answers
fi
<% end %>


# Install Puppet Enterprise
"${install_dir}"/puppet-enterprise-installer -a puppet.answers 2>&1 | tee install.log

# Finally, set up any custom facts if necessary
mkdir -p /etc/puppetlabs/facter/facts.d
<% if options[:facts] %>
echo "Installing custom facts"
<% options[:facts].each do |fact,value| %>
echo <%= fact %>=<%= value %> > /etc/puppetlabs/facter/facts.d/<%= fact %>.txt
<% end %>
<% end %>

# vim:ft=sh
